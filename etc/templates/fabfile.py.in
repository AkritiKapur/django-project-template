from fabric.api import task, run, local
import os
import boto
import time
from boto.s3.key import Key


COVERAGE_ENABLED = False
PROJECT_PACKGE = '${project-name}'
#Replace bucket_name, application_name, environment_name
#with the correct values alloted for your project
BUCKET_NAME = 'bucket_name'
FILE_NAME = 'build.zip'
APPLICATION_NAME = 'application_name'
ENVIRONMENT_NAME = 'environment_name'


def _ensure_dir(path):
    if not os.path.exists(path):
        os.makedirs(path)

@task()
def docs_gen():
    '''Generates Documents. Picks sources from docs folder.'''
    local("bin/sphinxbuilder")


@task()
def uml_gen():
    '''Generates Package Dependency Diagrams. Assumes Graphviz.'''
    local('bin/pyreverse -p deps %s' % PROJECT_PACKGE)
    local('mv *.dot out/')
    _ensure_dir('out/docs')
    local('dot -Tpng out/packages_deps.dot -o out/docs/packages_deps.png')


@task()
def runserver():
    '''Runs Django Server on port 8000'''
    local("bin/django runserver 0.0.0.0:8000")

@task()
def lint_py():
    '''Reports PyLint Errors & Warnings for Python files'''
    local('bin/pylint --rcfile=etc/lint.rc %s' % PROJECT_PACKGE)


@task()
def lint_js():
    '''Reports JSLint Errors & Warnings for JavaScript files'''
    local('bin/jshint --config=etc/jshint.json src/static/js')


@task()
def lint_css():
    '''Reports CSSLint Errors & Warnings for CSS files'''
    local('bin/csslint src/static/css') # TODO: Add option to specify csslint.json


@task()
def coverage():
    '''Enables Coverage. Used for test targets'''
    global COVERAGE_ENABLED
    COVERAGE_ENABLED = True


@task()
def test_all():
    '''Runs All Tests in src and tests folders'''
    test()


@task()
def test_integration():
    '''Runs All Tests in tests/integration package'''
    test('integration')


@task()
def test_unit():
    '''Runs All Tests in tests/unit package'''
    test('unit')


def test(package=''):
    '''Run Tests for the given package'''
    options = ['--with-progressive']

    if COVERAGE_ENABLED:
        options.append('--with-coverage')
        options.append('--cover-package=%s' % PROJECT_PACKGE)
        options.append('--cover-min-percentage=80')

    local('bin/test test {0} {1}'.format(package, ' '.join(options)))

@task()
def deploy_to_dev_environment():
    version = "build_"+str(int(time.time()))
    upload_to_s3(BUCKET_NAME, version, FILE_NAME)
    create_version(APPLICATION_NAME, version)
    update_environment(ENVIRONMENT_NAME, version)

@task()
def create_new_version(version):
    upload_to_s3(BUCKET_NAME, version, FILE_NAME)
    create_version(APPLICATION_NAME, version)

def upload_to_s3(bucket_name, key, file_name):
    conn = boto.connect_s3()
    bucket = conn.get_bucket(bucket_name)
    k = Key(bucket)
    k.key = key
    k.set_contents_from_filename(file_name)


def create_version(application, version):
    beanstalk = boto.connect_beanstalk()
    beanstalk.create_application_version(application, version,
                                         s3_bucket=BUCKET_NAME,
                                         s3_key=version)

def update_environment(environment, version):
    beanstalk = boto.connect_beanstalk()
    beanstalk.update_environment(environment_name=environment,
                                 version_label=version)
